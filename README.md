# ChromeLazyloadTest

Chrome 75にて以下の遅延読み込みが実装されました。

```html
<img src="./2.png" loading="lazy">
```

ブラウザネイティブで画像が画面に見えるようになるまで読み込みをしないというのは非常に嬉しい一方、いろいろ挙動が変わってくるのでそのテストです。

ちなみに75のCanaryでも不完全にしか動作してないので、実際の検証はもう少し後になりそうです。

メモ：77.0.3854.0 搭載されて設定はできるようになったがデモの画像が全部200になってしまう。他にも動作条件があるのかちゃんと動いていないのか不明。

フラグ立てでなんとかなりそうだが、デフォルトで組み込まれる挙動を見ないとあんまり意味ないと思うので、フラグ無しでちゃんと動くのを待っている。
（後フラグ立てたときの挙動が安定しない……）

## 大雑把な挙動

### 対応サーバー

ローカルでは正常に作動しません。
また先頭から2KB読み込み、必要ならちゃんと全部読み込むみたいな感じになります。
そのため、部分的に読み込んで返す機能が実装されていないWebサーバーではうまく動きません。

### 通信量

現段階ではありますが、遅延読み込みの場合は必ず初めに2KB読み込み(正常なら206が返ってくる)、その後必要ならファイル全体を読み込み(正常なら200を返し)ます。

ファイルサイズが2KB未満でも再度リクエストが飛ぶため、やたらめったら遅延読み込みを有効にすると、小さい画像の場合余計な通信が発生してしまいます。

## 実験1：遅延読み込みなしで最初から見える

リクエストの仕方を見ます。
遅延読み込みなしの場合は部分読み込みが有効になるのかどうかが肝です。

ちなみに正確な判定のため、ブラウザデフォルト設定ではなく明確に遅延読み込みを拒否します。

```html
<img src="./1.png" loading="eager">
```

こちらは普通にアクセスして200が返ってきています。

## 実験2：遅延読み込みありで最初から見える

リクエストの仕方を見ます。
挙動的には全部2KB読み込むので、これも例外なく部分→全体でしょう。

```html
<img src="./2.png" loading="lazy">
```

## 実験3：遅延読み込みなしで最初から見えない

こちらもリクエストの仕方を見ます。

```html
<img src="./3.png" loading="eager">
```

こちらは普通にアクセスして200が返ってきています。

## 実験4：遅延読み込みありで最初から見えない

こちらは正常な挙動であれば、部分読み込み→全体は読み込まない→スクロールで全体読み込みという流れになるはず。

## 実験5：遅延読み込みありで`display: none;`指定

旧実装だと遅延読み込みあり＋`display: none;`の場合はそもそも全体リクエストが飛ばないらしいので、その確認。

## 実験6：遅延読み込みありで`visibility: hidden;`指定

旧実装の場合でもこの場合は普通に読み込むらしいのでその確認。

## 実験7：遅延読み込みありでJSで`<img>`を作って挿入

旧実装の遅延読み込みの場合JSで作った `<img>` には遅延読み込みが有効にならなかったそうです。
しかし旧実装は全体に対して有効無効を指定できた（個別設定ができなかったらしい）ため、今回は動的に要素を作った後遅延読み込みを有効にして画像を読み込ませてみます。

```js
const img = document.createElement( 'img' );
// IDL属性らしいのでこれでいける。
//img.loading = 'lazy';
// しかし未対応ブラウザでもエラーなく動作させるため、普通に属性追加する。
img.setAttribute( 'loading', 'lazy' );
// src指定後にloadingを設定しても無効な可能性があるため、必ず最後に指定する。
img.src = '*****';
```

この挙動によっては実験をいくつか追加予定です。
ただ、もしこれが有効にならない場合、SPAはかなり苦しいというか、やはり自前で遅延読み込みが必要になるということになってしまいます。
（正直その場合この遅延読み込みはそんなに有用でないなと。）
